{% include "_header.html" %}
<title>Causmos - Create</title>
</head>

<body>
  {% include "_title.html" %}
  <div class="columns">
    <div class="column">
    </div>
    <div class="column">
      <div id="all_content" class="align-left main-window">
        <div class="dropdown">
          <div class="dropdown-trigger">
            <button class="button is-success" aria-haspopup="true" aria-controls="dropdown-menu">
              <span class="material-symbols-outlined icon">
                add_box
              </span>
              <span>Add New Datasource</span>
              <span class="material-symbols-outlined icon">
                arrow_drop_down
              </span>
            </button>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              {% if auth_adwords=="true" %}
              <a id="gads_link" href="#" onclick="addGoogleAdsDatasource();" class="dropdown-item">
                Google Ads
              </a>
              {% endif %}
              {% if auth_analytics=="true" %}
              <a id="ga4_link" href="#" onclick="addGa4Datasource();" class="dropdown-item">
                Google Analytics 4
              </a>
              {% endif %}
              <a id="csv_link" href="#" onclick="addCsvDatasource();" class="dropdown-item">
                CSV{% if auth_sheets=="true" %} & Google Sheet{% endif %}
              </a>
              {% if auth_sheets=="true" %}
              <a id="bq_link" href="#" onclick="addBqDatasource();" class="dropdown-item">
                BigQuery Data
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tooltip float-right">
          <span class="material-symbols-outlined is-small">
            help
          </span>
          <span class="tooltiptext">Signing in to your Google account gives you access to any Google Sheets, Google Ads
            and Google Analytics 4 accounts you have access to and will appear under datasources. It also enables you to
            export your results to Slides automatically.
          </span>
        </div>
        <div class="float-right">
          <button class="button is-light" onclick="showAdvancedOptions();">
            <span class="material-symbols-outlined icon">
              settings
            </span> <span>Settings</span>
          </button>
          <a href="oauth">
            {% if auth_adwords=="false" and auth_analytics=="false" and auth_sheets=="false" and auth_slides=="false"
            %}
            <button class="button is-info">
              <span class="material-symbols-outlined icon">
                account_circle
              </span>
              <span>
                Sign In
              </span>
              {% elif auth_adwords=="false" or auth_analytics=="false" or auth_sheets=="false" or auth_slides=="false"
              %}
              <button class="button is-info">
                <span class="material-symbols-outlined icon">
                  account_circle
                </span>
                <span>
                  Partially Signed In
                </span>
                {% else %}
                <button class="button is-light">
                  <span class="material-symbols-outlined icon">
                    verified
                  </span>
                  <span>
                    Fully Signed In
                  </span>
                  {% endif %}
                </button>
          </a>
        </div>
        <div id="final_gads" class="is-hidden final-datasource">
          <div><strong>Google Ads Datasource</strong>
            <div class="float-right">
              <button class="button is-info" onclick="addGoogleAdsDatasource();">
                <span class="material-symbols-outlined icon">
                  edit
                </span>
              </button>
              <button class="button is-danger" onclick="deleteGoogleAdsDatasource();">
                <span class="material-symbols-outlined icon">
                  delete_forever
                </span>
              </button>
            </div>
          </div>
          <div id="final_gads_details"></div>
        </div>
        <div id="final_ga4" class="is-hidden final-datasource">
          <div><strong>Google Analytics Datasource</strong>
            <div class="float-right">
              <button class="button is-info" onclick="addGa4Datasource();">
                <span class="material-symbols-outlined icon">
                  edit
                </span>
              </button>
              <button class="button is-danger" onclick="deleteGa4Datasource();">
                <span class="material-symbols-outlined icon">
                  delete_forever
                </span>
              </button>
            </div>
          </div>
          <div id="final_ga4_details"></div>
        </div>

        <div id="final_csv" class="is-hidden final-datasource">
          <div><strong>CSV & Google Sheet Datasource</strong>
            <div class="float-right">
              <button class="button is-info" onclick="addCsvDatasource();">
                <span class="material-symbols-outlined icon">
                  edit
                </span>
              </button>
              <button class="button is-danger" onclick="deleteCsvDatasource();">
                <span class="material-symbols-outlined icon">
                  delete_forever
                </span>
              </button>
            </div>
          </div>
          <div id="final_csv_details"></div>
        </div>

        <div id="final_bq" class="is-hidden final-datasource">
          <div><strong>BigQuery Datasource</strong>
            <div class="float-right">
              <button class="button is-info" onclick="addBqDatasource();">
                <span class="material-symbols-outlined icon">
                  edit
                </span>
              </button>
              <button class="button is-danger" onclick="deleteBqDatasource();">
                <span class="material-symbols-outlined icon">
                  delete_forever
                </span>
              </button>
            </div>
          </div>
          <div id="final_bq_details"></div>
        </div>

        <div id="no_datasources" class="final-datasource">
          <i>There are no datasources currently added</i>
        </div>
        <div id="general_settings" class="final-datasource">

          <div class="columns align-middle">
            <div class="column is-narrow">
              <label for="target_event_dd">Target Event</label>
              <div class="tooltip float-right">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Target Event is the main event your want to model your causal impact again.
                  e.g. sales, conversions or revenue.
                </span>
              </div><br>
              <div id="target_event_div" class="select">
                <select class="dd-width" id="target_event_dd" onchange="target_event_dd_change();">
                </select>
              </div>
            </div>
          </div>
          <div class="columns align-middle">
            <div class="column is-one-fifth">
              <label for="from_date">Date From</label>
              <div class="tooltip float-right">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Date From is the beginning of your data period, also known as the first day of
                  your 'Pre-Period'
                </span>
              </div>
              <input id="from_date" class="input date-picker" type="date" onchange="validation();">
              <div id="from_date_label" class="info float-right"></div>
            </div>
            <div class="column is-one-fift info align-center-text">← Pre-period →</div>
            <div class="column is-one-fifth">
              <label for="event_date">Event Date</label>
              <div class="tooltip float-right">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Event Date to is when your event/change started, also known as the first day
                  of your 'Post-Period'
                  and also defines your 'Pre-Period' last day minus 1
                </span>
              </div>
              <input id="event_date" class="input" type="date" onchange="validation();">
            </div>
            <div class="column is-one-fift info align-center-text">← Post-period →</div>
            <div class="column is-one-fifth">
              <label for="to_date">Date To</label>
              <div class="tooltip float-right">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Date To to is the end of your data period, also known as the last date of your
                  'Post-Period'
                </span>
              </div>
              <input id="to_date" class="input" type="date" onchange="validation();">
              <div id="to_date_label" class="info float-right"></div>
            </div>
            <div class="column">
              <span id='date_error' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                Date From must be before Date To
              </span>
            </div>
          </div>
          <div class="columns align-middle">
            <div class="column">
              <span id='csv_date_error' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                <span id="csv_date_error_msg"></span>
              </span>
              <span id='date_3_days' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                There must be at least 3 days between From date and Event date
              </span>
              <span id='event_date_error' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                Event Date must be within selected date range
              </span>
            </div>
          </div>
          <hr>
          <div class="columns">
            <div class="column is-one-quarter">
              <label>Validation Tests</label>
            </div>
            <div class="column is-one-quarter">
              <label class="checkbox align-left">
                <input id="matrix_check" type="checkbox" onclick="validation_change();">
                Correlation Matrix
              </label>
              <div class="tooltip">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Correlation Matrix Validation correlates the first 10 covariates (including
                  the target event) against each other to
                  understand the linear relationship between each pair of covariates. High values indicate strong linear
                  relationship
                  between two covariates where a low value indicates a poor linear relationship.
                </span>
              </div>
            </div>
            <div class="column is-one-quarter">
              <label class="checkbox align-left">
                <input id="pre_period_check" type="checkbox" onclick="validation_change();">
                Pre-Period
              </label>
              <div class="tooltip">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Pre-Period Validation test takes the pre-period from your Causal Impact
                  analysis and does a 75/25% split of the date range as a new pre and post-period to confirm if there
                  are any natural causal impact during the period before the target event happened.
                  <br>
                  <br>
                  Requires at least 5 days between Date From and Event Date
                </span>
              </div>
            </div>
            <div class="column is-one-quarter">
              <label class="checkbox align-left">
                <input id="unaffectedness_check" type="checkbox" onclick="validation_change();">
                Unaffectedness
              </label>
              <div class="tooltip">
                <span class="material-symbols-outlined is-small">
                  help
                </span>
                <span class="tooltiptext">Unaffectedness Validation test removes the target event from the data, and
                  checks the selected event to ensure there is no natural causal impact with other events over the same
                  date period as your original Causal Impact analysis.
                  <br>
                  <br>
                  Requires at least 3 metrics to be available in your data sources
                </span>
              </div>
              <div id="target_event_div" class="select">
                <select class="dd-width" id="unef_dd" onchange="validation_change();">
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="align-right single-level">
          <span id='three_metrics_error' class="tag is-warning is-hidden">
            <span class="material-symbols-outlined">
              warning
            </span>
            It is recommended to have 2 or more covariates in addition to your target event for best results
          </span>
          <div>
            <button class="button is-danger" onclick="resetAnalysis();">
              <span class="material-symbols-outlined icon">
                restart_alt
              </span>
              <span>Reset Analysis</span>
            </button>
            <form class="float-right left-padding" id="run_analysis_form" method="post" action="/report">
              <input type="hidden" id="data_to_send" name="data_to_send">
              <button type="submit" id="run_analysis" class="button is-success" value="" disabled>
                <span class="material-symbols-outlined icon">
                  monitoring
                </span>
                <span>Run Analysis</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="column">
    </div>
  </div>

  <div id="google_ads_datasource_tab" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Google Ads Datasource</p>
      </header>
      <section class="modal-card-body">
        <div class="field align-left columns level-left">
          <div class="column is-narrow">
            <label for="gads_mcc_id_dd" class="label">MCC ID</label>
          </div>
          <div class="control column">
            <div id="gads_mcc_div" class="select">
              <select class="dd-width" onchange="getGadsCustomerList();" id="gads_mcc_id_dd">
              </select>
            </div>
            <span id="gads_locked" class="tag is-warning is-light is-hidden">
              <span class="material-symbols-outlined">
                info
              </span>
              Can only use 1 MCC account per analysis due to data privacy</span>
          </div>
        </div>
        <div class="columns">
          <div class="column is-three-fifths rounded-outline">
            <div class="level">
              <div class="level-item has-text-centered">
                <div>
                  <label for="gads_customer_dd" class="label">Customer</label>
                  <div id="gads_customer_div" class="select">
                    <select class="dd-width" onchange="getCampaignList();" id="gads_customer_dd">
                    </select>
                  </div>
                </div>
              </div>
              <div class="level-item has-text-centered">
                <div>
                  <label for="gads_campaign_dd" class="label">Campaign</label>
                  <div id="gads_campaign_div" class="select">
                    <select class="dd-width" onchange="" id="gads_campaign_dd">
                    </select>
                  </div>
                </div>
              </div>
              <div class="level-item has-text-centered">
                <div>
                  <button onclick="addGadsCustomerCampaign();" class="button is-info">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="level">
              Selected Customer(s) and Campaign(s)
            </div>
            <div class="level">
              <div id="gads_customer_boxes" class="align-left"></div>
            </div>
          </div>
          <div class="column rounded-outline">
            <div class="level">
              <div class="level-item has-text-centered">
                <div>
                  <label for="gads_metric_dd" class="label">Variable</label>
                  <div class="select">
                    <select class="dd-width" onchange="" id="gads_metric_dd">
                    </select>
                  </div>
                </div>
              </div>
              <div class="level-item has-text-centered">
                <div>
                  <button onclick="addGadsMetric();" class="button is-info">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="level">
              Selected Variable(s)
            </div>
            <div class="level">
              <div id="gads_metrics_boxes" class="align-left"></div>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="gads_save_button" onclick="saveGoogleAdsDatasource();" class="button is-success">
          <span class="material-symbols-outlined icon">
            save
          </span>
          <span>Save Datasource</span>
        </button>
        <button onclick="cancelGoogleAdsDatasouce();" class="button">
          <span>Cancel</span>
          <span class="material-symbols-outlined icon">
            cancel
          </span>
        </button>
        <span id='gads_selection_error' class="tag is-danger is-hidden">
          <span class="material-symbols-outlined">
            warning
          </span>
          Must have 1 of each type selected or nothing selected to Save
        </span>
      </footer>
    </div>
  </div>

  <div id="google_analytics_datasource_tab" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Google Analytics Datasource</p>
      </header>
      <section class="modal-card-body">
        <div class="field align-left columns level-left">
          <div class="column is-narrow">
            <label for="ga4_account_id_dd" class="label">Account</label>
          </div>
          <div class="control column">
            <div id="ga4_account_div" class="select">
              <select class="dd-width" onchange="getGa4PropertyList();" id="ga4_account_id_dd">
              </select>
            </div>
          </div>

          <div class="column is-narrow">
            <label for="ga4_property_id_dd" class="label">Property</label>
          </div>
          <div class="control column">
            <div id="ga4_property_div" class="select">
              <select class="dd-width" onchange="" id="ga4_property_id_dd">
              </select>
            </div>
          </div>
        </div>
        <div class="columns">
          <div class="column rounded-outline">
            <div class="level">
              <div class="level-item is-narrow">
                <div>
                  <label for="ga4_metric_dd" class="label">Variable</label>
                  <div class="select">
                    <select class="dd-width" onchange="" id="ga4_metric_dd">
                    </select>
                  </div>
                </div>
                <div class="single-level">
                  <button onclick="addGa4Metric();" class="button is-info">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="level">
              Selected Variable(s)
            </div>
            <div class="level">
              <div id="ga4_metrics_boxes" class="align-left"></div>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="ga4_save_button" onclick="saveGa4Datasource();" class="button is-success">
          <span class="material-symbols-outlined icon">
            save
          </span>
          <span>Save Datasource</span>
        </button>
        <button onclick="cancelGa4Datasource();" class="button">
          <span>Cancel</span>
          <span class="material-symbols-outlined icon">
            cancel
          </span>
        </button>
      </footer>
    </div>
  </div>

  <div id="csv_datasource_tab" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">
          CSV & Google Sheets Datasource</p>
      </header>
      <section class="modal-card-body">
        <div class="columns">
          <div class="column is-one-fifth">
            Datasource
          </div>
          <div class="column is-one-fifth">
            <div id="ds_options" class="tags has-addons">
              <a href="#" onclick="csv_option_click();"><span id="csv_option_span" class="tag is-link">CSV</span></a>
              {% if auth_sheets=="true" %}
              <a href="#" onclick="gsheet_option_click();"><span id="gsheet_option_span"
                  class="tag is-light">gSheet</span></a>
              {% endif %}
            </div>
          </div>
        </div>
        <div id="csv_option">
          <div class="columns">
            <div class="column is-one-fifth">
              File Upload
            </div>
            <div class="column is-two-fifth align-left">
              <form id="file_upload_form">
                <input id="file_upload" type="file" name="file" hidden>
                <label class="file-button" for="file_upload">Choose File</label>
                <span id="file_name">...</span>
              </form>
              <span id='file_too_big' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                <span id="file_too_big_msg">File size is over 250kb. Use a smaller file or use Google Sheets for larger
                  amounts of data.</span>
              </span>
            </div>
            <div class="column is-three-fifth">
              <button id="getCsv" class="button is-info" onclick="uploadFile();">
                <span class="material-symbols-outlined icon">
                  upload_file
                </span>
                <span>Upload</span>
              </button>
              <div id="uploading_div" class="left-padding"></div>
            </div>
            <span id='csv_upload_error' class="tag is-danger is-hidden">
              <span class="material-symbols-outlined">
                warning
              </span>
              <span id="csv_upload_error_msg"></span>
            </span>
          </div>
          <div class="columns">
            <div class="column is-full">
              <div class="info">CSV format requires a coulmn heading with 'date' and in the format yyyy-mm-dd. 250kb max
                size CSV file. For larger, use Google Sheets
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet_option" class="is-hidden">
          <div class="columns">
            <div class="column is-one-fifth align-right"><label for="gsUrl">Google Sheet URL or ID</label>
            </div>
            <div class="column is-three-fifths align-left"><input class="input" onchange="sheet_changed();" type="text"
                id="gsUrl">
            </div>
            <div class="column is-one-fifth"><button id="getGsSheet" class="button is-info" onclick="uploadGs();">
                <span class="material-symbols-outlined icon">
                  download
                </span>
                <span>Get Sheet</span>
              </button>
            </div>
          </div>
          <div id="gsheet_tab_div" class="columns is-hidden">
            <div class="column is-one-fifth align-right">
              <label for="gsheet_tabs">Tab</label>
            </div>
            <div class="column is-narrow align-left">
              <div class="select">
                <select class="dd-width" onchange="uploadGs();" id="gsheet_tabs">
                </select>
              </div>
              <br><br>
              <span id='gs_upload_error' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                <span id="gs_upload_error_msg"></span>
              </span>
            </div>
          </div>
          <div class="columns">
            <div class="column is-full">
              <div id="gs_url_email" class="info">
                There must be a 'date' column in yyyy-mm-dd format
              </div>
            </div>
          </div>
        </div>

        <div id="csv_options" class="columns is-hidden">
          <div class="column rounded-outline">
            <div class="level">
              <div id="csv_datasource_box"></div>
            </div>
            <div class="level">
              <div>
                <label for="csv_date_dd" class="label">Date Column</label>
                <div class="select">
                  <select class="dd-width" id="csv_date_dd">
                  </select>
                </div>
              </div>
            </div>
            <div class="level">
              <div class="level-item is-narrow">
                <div>
                  <label for="csv_metric_dd" class="label">Variable</label>
                  <div class="select">
                    <select class="dd-width" id="csv_metric_dd">
                    </select>
                  </div>
                </div>
                <div class="single-level">
                  <button onclick="addCsvMetric();" class="button is-info">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add</span>
                  </button>
                  <button onclick="addAllCsvMetric();" class="button is-info is-light">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add All</span>
                  </button>
                  <button id="clear_all_csv_metric" onclick="clearAllCsvMetric();" class="button is-danger is-light">
                    <span class="material-symbols-outlined icon">
                      delete_forever
                    </span>
                    <span>Clear All</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="level">
              <div>
                <span id='ds' class='tag'></span> Selected Variable(s)
              </div>
            </div>
            <div class="level">
              <div id="csv_metrics_boxes" class="align-left"></div>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="csv_save_button" onclick="saveCsvDatasource();" class="button is-success">
          <span class="material-symbols-outlined icon">
            save
          </span>
          <span>Save Datasource</span>
        </button>
        <button onclick="cancelCsvDatastore();" class="button">
          <span>Cancel</span>
          <span class="material-symbols-outlined icon">
            cancel
          </span>
        </button>
      </footer>
    </div>
  </div>
  <div id="bq_datasource_tab" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">
          BigQuery Datasource</p>
      </header>
      <section class="modal-card-body">
        <div class="columns">
          <div class="column is-one-fifth">
            Datasource
          </div>
          <div class="column is-one-fifth">
            <span id="bq_option_span" class="tag is-danger">BigQuery</span>
          </div>
        </div>
        <div id="bq_option">
          <div class="columns">
            <div class="column is-one-quarter">
              Project ID
              <input class="input" type="text" id="bqProjectId">
            </div>
            <div class="column is-one-quarter">
              Dataset
              <input class="input" type="text" id="bqDataset">
            </div>
            <div class="column is-one-quarter">
              Table
              <input class="input" type="text" id="bqTable">
            </div>
            <div class="column is-one-quarter"><button id="getBqSheet" class="button is-info" onclick="uploadBq();">
                <span class="material-symbols-outlined icon">
                  download
                </span>
                <span>Get BQ Data</span>
              </button>
            </div>
          </div>
          <div class="columns">
            <div class="column is-full">
              <span id='bq_upload_error' class="tag is-danger is-hidden">
                <span class="material-symbols-outlined">
                  warning
                </span>
                <span id="bq_upload_error_msg"></span>
              </span>
              <div id="bq_url_email" class="info">
                Table needs a 'date' column in the format 'yyyy-mm-dd' and all other columns must be integer or float and no NULL values. Any columns with invalid date will be omitted from the data sets.
              </div>
            </div>
          </div>
        </div>

        <div id="bq_options" class="columns is-hidden">
          <div class="column rounded-outline">
            <div class="level">
              <div id="bq_datasource_box"></div>
            </div>
            <div class="level">
              <div class="level-item is-narrow ">
                <div class="single-level">
                  <label for="bq_date_dd" class="label">Date Column</label>
                  <div class="select">
                    <select class="dd-width" id="bq_date_dd">
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="level">
              <div class="level-item is-narrow">
                <div class="single-level">
                  <label for="bq_metric_dd" class="label">Variable
                    <div class="tooltip float-right">
                      <span class="material-symbols-outlined is-small">
                        help
                      </span>
                      <span class="tooltiptext">This are the variables you want to use as your target event or
                        covariates
                      </span>
                    </div>
                  </label>
                  <div class="select" id="bq_metric_div">
                    <select class="dd-width" id="bq_metric_dd">
                    </select>
                  </div>
                </div>
                <div class="single-level">
                  <button id="add_bq_metric" onclick="addBqMetric();" class="button is-info">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add</span>
                  </button>
                  <button id="add_all_bq_metric" onclick="addAllBqMetric();" class="button is-info is-light">
                    <span class="material-symbols-outlined icon">
                      add_box
                    </span>
                    <span>Add All</span>
                  </button>
                  <button id="clear_all_bq_metric" onclick="clearAllBqMetric();" class="button is-danger is-light">
                    <span class="material-symbols-outlined icon">
                      delete_forever
                    </span>
                    <span>Clear All</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="level">
              <div>
                Selected Variables (Metric)
              </div>
            </div>
            <div class="level">
              <div id="bq_metrics_boxes" class="align-left"></div>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="bq_save_button" onclick="saveBqDatasource();" class="button is-success">
          <span class="material-symbols-outlined icon">
            save
          </span>
          <span>Save Datasource</span>
        </button>
        <button onclick="cancelBqDatasource();" class="button">
          <span>Cancel</span>
          <span class="material-symbols-outlined icon">
            cancel
          </span>
        </button>
      </footer>
    </div>
  </div>

  <div id="advanced_options" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Advanced Settings</p>
      </header>
      <section class="modal-card-body align-left">
        <br><br><br><br><br>
        <label>Credibility Interval</label>
        <div class="slidecontainer">
          <input type="range" min="80" max="95" value="95" step="5" class="slider slider-width" list="steplist"
            id="credibility_slider" onchange="credibilitySliderChange();">
          <datalist id="steplist">
            <option>80</option>
            <option>85</option>
            <option>90</option>
            <option>95</option>
          </datalist>
          <span class="slider-number" id="credibility_slider_value"></span>
          <div class="tooltip">
            <span class="material-symbols-outlined is-small">
              help
            </span>
            <span class="tooltiptext">A credibility interval is commonly used in Bayesian statistics. It represents a
              range of values for a parameter that are considered plausible
              given both an initial assumption (our “prior” for what we expect the effect to be) and the observed
              data.
              Unlike confidence intervals, Bayesian credibility intervals
              account for both the uncertainty in the data and the uncertainty in the prior information. Default is
              95%
              and this should only be adjusted if you know what it does.
            </span>
          </div>
        </div>
        <br><br><br><br><br>
      </section>
      <footer class="modal-card-foot">
        <button id="save_advanced_options" onclick="saveAdvancedOptions();" class="button is-success">
          <span class="material-symbols-outlined icon">
            save
          </span>
          <span>Save</span>
        </button>
        <button onclick="cancelAdvancedOptions();" class="button">
          <span>Cancel</span>
          <span class="material-symbols-outlined icon">
            cancel
          </span>
        </button>
      </footer>
    </div>
  </div>

  <div id="confirm_box" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p id="confirm_title" class="modal-card-title"></p>
      </header>
      <section class="modal-card-body">
        <p id="confirm_message"></p>
      </section>
      <footer class="modal-card-foot">
        <button id='confirm_yes' class="button is-success">Yes</button>
        <button id='confirm_no' class="button is-danger">No</button>
      </footer>
    </div>
  </div>

  <div id="loading_modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <section class="modal-card-body">
        <br><br><br>Please wait. Your datasources are loading and the results will be shown soon...
        <div class="spinner"></div>
      </section>
    </div>
  </div>

  <script>
    //Google Ads global variables
    var mcc_ids;
    var gads_data = { 'mcc_id': "", 'query': {}, 'metrics': [] };
    var tmp_gads_data = {};
    var gads_customer_lkup = {};
    var gads_campaign_lkup = {};
    var gads_metrics_lkup = {
      "average_cost": "Avg. Cost",
      "average_cpc": "Avg. CPC",
      "clicks": "Clicks",
      "conversions": "Conversions",
      "cost_micros": "Cost",
      "ctr": "Click Through Rate (CTR)",
      "impressions": "Impressions",
      "value_per_conversion": "Value Per Conversion",
      "video_views": "Video Views",
      "view_through_conversions": "View Through conversions"
    };

    //GA4 global variables
    var account_ids;
    var ga4_data = { 'account': "", 'property': "", 'metrics': [] };
    var tmp_ga4_data = {};
    var ga4_account_lkup = {};
    var ga4_property_lkup = {};
    var ga4_metrics_lkup = {
      "bounceRate": "Bounce Rate",
      "conversions": "Conversions",
      "firstTimePurchasers": "First Time Purchasers",
      "newUsers": "New Users",
      "screenPageViews": "Page Views",
      "purchaseRevenue": "Revenue (Purchases)",
      "totalRevenue": "Revenue (Total)",
      "sessions": "Sessions",
      "transactions": "Transactions",
      "userEngagementDuration": "Time on Site"
    };

    //Global variables
    var x_from_date = "";
    var x_to_date = "";
    var is_date_error = false;

    //CSV global variables
    var csv_data = { 'date_column': "", 'metrics': [], 'format': "" };
    var tmp_csv_data = {};
    var csv_metrics = [];
    var csv_from_date = "";
    var csv_to_date = "";
    var csv_items_loaded = false;
    var gsheet_tab_visible = false;
    var gs_sheet_changed = true;

    //BQ global variables
    var bq_data = { 'date_column': "", 'metrics': [] };
    var tmp_bq_data = {};
    var bq_metrics = [];
    var bq_from_date = "";
    var bq_to_date = "";
    var bq_items_loaded = false;

    count = 0;
    if (sessionStorage.getItem('gads_data')) {
      gads_data = JSON.parse(sessionStorage.getItem('gads_data'));
      gads_customer_lkup = JSON.parse(sessionStorage.getItem('gads_customer_lkup'));
      gads_campaign_lkup = JSON.parse(sessionStorage.getItem('gads_campaign_lkup'));
      gads_metrics_lkup = JSON.parse(sessionStorage.getItem('gads_metrics_lkup'));
      mcc_ids = JSON.parse(sessionStorage.getItem('mcc_ids'));
      _populateMccIds(gads_data.mcc_id);
      document.getElementById('gads_mcc_id_dd').value = gads_data.mcc_id
      _renderGoogleAdsDataSourceBoxes();
      count = +1
    }
    if (sessionStorage.getItem('ga4_data')) {
      ga4_data = JSON.parse(sessionStorage.getItem('ga4_data'));
      ga4_account_lkup = JSON.parse(sessionStorage.getItem('ga4_account_lkup'));
      ga4_property_lkup = JSON.parse(sessionStorage.getItem('ga4_property_lkup'));
      account_ids = JSON.parse(sessionStorage.getItem('account_ids'));
      _populateGa4Accounts(ga4_data.account);
      _renderGa4DatasourceBox();
      count = +1
    }
    if (sessionStorage.getItem('csv_data')) {
      csv_data = JSON.parse(sessionStorage.getItem('csv_data'));
      csv_metrics = JSON.parse(sessionStorage.getItem('csv_metrics'));
      csv_from_date = JSON.parse(sessionStorage.getItem('csv_from_date'));
      csv_to_date = JSON.parse(sessionStorage.getItem('csv_to_date'));
      _showMinMaxDates();
      if (sessionStorage.getItem('gsheet_url')) {
        document.getElementById('gsUrl').value = sessionStorage.getItem('gsheet_url');
        if (sessionStorage.getItem('gsheet_tabs')) {
          sheets = []
          sheets = JSON.parse(sessionStorage.getItem('gsheet_tabs'));
          gs_sheet_changed = false;
          _rendergSheetTabs(sheets, sessionStorage.getItem('gsheet_tab'));
        }
      }

      if (csv_data.format == "gsheet") {
        gsheet_option_click();
      }

      _renderCsvDatasourceBox();
      count = +1
    }
    if (sessionStorage.getItem('bq_data')) {
      bq_data = JSON.parse(sessionStorage.getItem('bq_data'));
      bq_metrics = JSON.parse(sessionStorage.getItem('bq_metrics'));
      bq_from_date = JSON.parse(sessionStorage.getItem('bq_from_date'));
      bq_to_date = JSON.parse(sessionStorage.getItem('bq_to_date'));

      if (sessionStorage.getItem('bq_project_id')) { document.getElementById('bqProjectId').value = sessionStorage.getItem('bq_project_id'); }
      if (sessionStorage.getItem('bq_dataset')) { document.getElementById('bqDataset').value = sessionStorage.getItem('bq_dataset'); }
      if (sessionStorage.getItem('bq_table')) { document.getElementById('bqTable').value = sessionStorage.getItem('bq_table'); }


      _renderBqDatasourceBox();
      count = +1
    }
    if (count > 0) { cleanUp(); }
    _populateGadsMetrics();
    _populateGa4Metrics();

    document.getElementById('file_upload').addEventListener('change', function (e) {
      if (e.target.files[0]) {
        document.getElementById('file_name').textContent = e.target.files[0].name;
      }
    });
    if (sessionStorage.getItem('x_from_date')) { x_from_date = sessionStorage.getItem('x_from_date'); }
    if (sessionStorage.getItem('x_to_date')) { x_to_date = sessionStorage.getItem('x_to_date'); _showMinMaxDates(); }
    if (sessionStorage.getItem('val_unef_check')) { document.getElementById('unaffectedness_check').checked = (sessionStorage.getItem('val_unef_check') == "true"); }
    if (sessionStorage.getItem('val_unef_option')) { document.getElementById('unef_dd').value = sessionStorage.getItem('val_unef_option'); }
    if (sessionStorage.getItem('val_matrix_check')) { document.getElementById('matrix_check').checked = (sessionStorage.getItem('val_matrix_check') == "true"); }
    if (sessionStorage.getItem('from_date')) { document.getElementById('from_date').value = sessionStorage.getItem('from_date'); }
    if (sessionStorage.getItem('to_date')) { document.getElementById('to_date').value = sessionStorage.getItem('to_date'); }
    if (sessionStorage.getItem('event_date')) { document.getElementById('event_date').value = sessionStorage.getItem('event_date'); }
    if (sessionStorage.getItem('val_pre_period_check')) { validation(); document.getElementById('pre_period_check').checked = (sessionStorage.getItem('val_pre_period_check') == "true"); }
    if (sessionStorage.getItem('credibility')) { document.getElementById('credibility_slider').value = sessionStorage.getItem('credibility'); }


    //Google Ads code
    function addGoogleAdsDatasource() {
      tmp_gads_data = JSON.parse(JSON.stringify(gads_data));

      if (mcc_ids == null) {
        const api_url = "/_get_gads_mcc_ids";
        addDDSpinner('gads_mcc_div');
        fetch(api_url)
          .then(response => response.json())
          .then(data => {
            mcc_ids = data.result;
            _populateMccIds();
            removeDDSpinner('gads_mcc_div');
          });
      }
      openPopup('google_ads_datasource_tab');
      _renderGoogleAdsBoxes();
      _renderGoogleAdsMetricsBoxes();
    }

    function _populateMccIds(mcc_id = 0) {
      if (mcc_ids != "error") {
        var first = true;
        var gads_mcc_id_dd = document.getElementById('gads_mcc_id_dd');
        mcc_ids.forEach((value) => {
          var newOption = new Option(value, value);
          gads_mcc_id_dd.add(newOption);
          if (mcc_id != 0 && first) {
            getGadsCustomerList(mcc_id);
            first = false;
          }
          else if (first) {
            getGadsCustomerList(value);
            first = false;
          }
        });
      }
    }

    function _populateGadsMetrics() {
      gads_metric_dd = document.getElementById('gads_metric_dd');
      for (const [metric_id, metric_name] of Object.entries(gads_metrics_lkup)) {
        var newOption = new Option(metric_name, metric_id);
        gads_metric_dd.add(newOption);
      }
    }

    function getGadsCustomerList(mcc_id = 0) {
      addDDSpinner('gads_customer_div');
      //addDDSpinner('gads_campaign_div');
      mcc_dd = document.getElementById('gads_mcc_id_dd');
      mcc_dd.disabled = true;
      if (mcc_id == 0) {
        var mcc_id = mcc_dd.value;
      }
      const api_url = "/_get_gads_customer_ids?mcc_id=" + mcc_id;
      var first = true;
      gads_customer_dd = document.getElementById('gads_customer_dd');
      gads_customer_dd.innerHTML = "";
      gads_campaign_dd = document.getElementById('gads_campaign_dd');
      gads_campaign_dd.innerHTML = "";
      fetch(api_url)
        .then(response => response.json())
        .then(data => {
          customers = data.result;
          if (customers != "error") {
            customers.forEach((value) => {
              var newOption = new Option(value[0] + " (" + value[1] + ")", value[1]);
              gads_customer_dd.add(newOption);
              if (first && value[1] != 0) {
                getCampaignList(mcc_id, value[1]);
                first = false;
              }
            })
          }
          if (first) {
            removeDDSpinner('gads_campaign_div');
            mcc_dd.disabled = false;
            removeDDSpinner('gads_customer_div');
            customer_dd.disabled = false;
            var newOption = new Option("No accounts in MCC", 0);
            gads_customer_dd.add(newOption);
          }
          removeDDSpinner('gads_customer_div');
        });
    }

    function getCampaignList(mcc_id = 0, customer_id = 0) {
      mcc_dd = document.getElementById('gads_mcc_id_dd');
      customer_dd = document.getElementById('gads_customer_dd');
      customer_dd.disabled = true;
      mcc_dd.disabled = true;
      if (mcc_id == 0 && customer_id == 0) {
        mcc_id = document.getElementById('gads_mcc_id_dd').value;
        customer_id = document.getElementById('gads_customer_dd').value;
      }
      addDDSpinner('gads_campaign_div');
      if (mcc_id == 0) {
        var mcc_id = document.getElementById('gads_mcc_id_dd').value;
      }
      if (customer_id != 0) {
        const api_url = "/_get_gads_campaigns?mcc_id=" + mcc_id + "&customer_id=" + customer_id;
        gads_campaign_dd = document.getElementById('gads_campaign_dd');
        gads_campaign_dd.innerHTML = "";
        first = true;
        fetch(api_url)
          .then(response => response.json())
          .then(data => {
            campaigns = data.result;
            if (campaigns != "error") {
              campaigns.forEach((value) => {
                if (first && value[1] != 0) {
                  var newOption = new Option("-- All --", customer_id + "-0");
                  gads_campaign_dd.add(newOption);
                  first = false;
                }
                var newOption = new Option(value[0], value[1]);
                gads_campaign_dd.add(newOption);
              })
            }
            removeDDSpinner('gads_campaign_div');
            mcc_dd.disabled = false;
            removeDDSpinner('gads_customer_div');
            customer_dd.disabled = false;
          });
      }
    }

    function addGadsCustomerCampaign() {
      const customer_id_dd = document.getElementById('gads_customer_dd');
      const campaign_id_dd = document.getElementById('gads_campaign_dd');
      if (customer_id_dd.options[customer_id_dd.selectedIndex] != null && customer_id_dd.options[customer_id_dd.selectedIndex].value != 0 && campaign_id_dd.options[campaign_id_dd.selectedIndex] != null && campaign_id_dd.options[campaign_id_dd.selectedIndex].value != 0) {
        const customer_id = customer_id_dd.value;
        const customer_name = customer_id_dd.options[customer_id_dd.selectedIndex].text;

        const campaign_id = campaign_id_dd.value;
        const campaign_name = campaign_id_dd.options[campaign_id_dd.selectedIndex].text;

        if (gads_data.query[customer_id] == null) {
          gads_data.query[customer_id] = [];
          gads_customer_lkup[customer_id] = customer_name;
        }
        if (!gads_data.query[customer_id].includes(campaign_id)) {
          if ((gads_data.query[customer_id].length > 0 && campaign_id == customer_id + "-0") || (gads_data.query[customer_id].includes(customer_id + "-0"))) {
            gads_data.query[customer_id] = [campaign_id];
          }
          else {
            gads_data.query[customer_id].push(campaign_id);
          }
          gads_campaign_lkup[campaign_id] = campaign_name;
        }
        gads_data.mcc_id = document.getElementById('gads_mcc_id_dd').value;
        _renderGoogleAdsBoxes();
      }
    }

    function addGadsMetric() {
      const gads_metric_dd = document.getElementById('gads_metric_dd');
      const gads_metric = gads_metric_dd.value;
      const gads_metric_name = gads_metric_dd.options[gads_metric_dd.selectedIndex].text;

      if (!gads_data.metrics.includes(gads_metric)) {
        gads_data.metrics.push(gads_metric);
      }
      _renderGoogleAdsMetricsBoxes();
    }

    function deleteGadsMetric(metric) {
      gads_data.metrics.splice(gads_data.metrics.indexOf(metric), 1);
      _renderGoogleAdsMetricsBoxes();
    }

    function deleteGadsItem(customer_id, campaign_id = 0) {
      if (gads_data.query[customer_id].length == 1 || campaign_id == 0) {
        delete gads_data.query[customer_id];
      }
      else {
        gads_data.query[customer_id].splice(gads_data.query[customer_id].indexOf(campaign_id), 1);
      }
      _renderGoogleAdsBoxes();
    }

    function saveGoogleAdsDatasource() {
      const final_gads_details = document.getElementById('final_gads_details');

      if (Object.keys(gads_data.query).length == 0 && Object.keys(gads_data.metrics).length == 0) {
        closePopup('final_gads');
        closePopup('google_ads_datasource_tab');
        closePopup('gads_selection_error');
        final_gads_details.innerHTML = "";
      }
      else if (Object.keys(gads_data.query).length == 0 || Object.keys(gads_data.metrics).length == 0) {
        openPopup('gads_selection_error');
      }
      else {
        closePopup('gads_selection_error');
        _renderGoogleAdsDataSourceBoxes();

        sessionStorage.setItem('gads_data', JSON.stringify(gads_data));
        sessionStorage.setItem('mcc_ids', JSON.stringify(mcc_ids));
        sessionStorage.setItem('gads_customer_lkup', JSON.stringify(gads_customer_lkup));
        sessionStorage.setItem('gads_campaign_lkup', JSON.stringify(gads_campaign_lkup));
        sessionStorage.setItem('gads_metrics_lkup', JSON.stringify(gads_metrics_lkup));
        closePopup('google_ads_datasource_tab');
      }
      cleanUp();
    }

    function _renderGoogleAdsDataSourceBoxes() {
      const final_gads_details = document.getElementById('final_gads_details');
      final_gads_details.innerHTML = "Customer(s) and Campaign(s)<br>";

      for (const [customer_id, campaign_ids] of Object.entries(gads_data.query)) {
        final_gads_details.innerHTML += "<span class='tag is-info'>" + gads_customer_lkup[customer_id] + "</span> ";
        campaign_ids.forEach((campaign_id) => {
          final_gads_details.innerHTML += "<span class='tag is-info is-light'>" + gads_campaign_lkup[campaign_id] + "(" + campaign_id + ")</span> ";
        })
        final_gads_details.innerHTML += "<br>"
      }

      final_gads_details.innerHTML += "<br>Variable(s)<br>";
      gads_data.metrics.forEach((metric) => {
        final_gads_details.innerHTML += "<span class='tag is-info'>" + gads_metrics_lkup[metric] + "</span> ";
      });
      openPopup('final_gads');
    }

    function cancelGoogleAdsDatasouce() {
      gads_data = JSON.parse(JSON.stringify(tmp_gads_data));
      closePopup('gads_selection_error');
      closePopup('google_ads_datasource_tab');
      cleanUp();
    }

    function deleteGoogleAdsDatasource() {
      confirmBox("Delete Google Ads Datasource",
        "Are you sure you want to delete the Google Ads datasource?",
        function () {
          gads_data = { 'query': {}, 'metrics': [] };
          tmp_gads_data = {};
          closePopup('final_gads');
          sessionStorage.removeItem('gads_data');
          cleanUp();
        },
        function () { });
    }

    function resetAnalysis(bp = false) {
      if (bp) {
        sessionStorage.clear();
        window.location.replace("/sessionExpired");
      }
      else {
        confirmBox("Reset Analysis form",
          "Are you sure you want to reset all the settings and delete datasources?",
          function () {
            sessionStorage.clear();
            location.reload();
          },
          function () { });
      }
    }

    function _renderGoogleAdsMetricsBoxes() {
      gads_metrics_boxes = document.getElementById('gads_metrics_boxes');
      gads_metrics_boxes.innerHTML = "";

      gads_data.metrics.forEach((item) => {
        gads_metrics_boxes.innerHTML += "<span class='tag is-info'>" + gads_metrics_lkup[item] + "<button onClick='deleteGadsMetric(\"" + item + "\");' class='delete is-small'></button></span> ";
      })
    }

    function _renderGoogleAdsBoxes() {
      const mcc_id = document.getElementById('gads_mcc_id_dd');
      const customer_boxes = document.getElementById('gads_customer_boxes');

      if (Object.keys(gads_data.query).length > 0) {
        mcc_id.disabled = true;
      }
      else {
        mcc_id.disabled = false;
      }
      customer_boxes.innerHTML = "";
      for (const [customer_id, campaign_ids] of Object.entries(gads_data.query)) {
        customer_boxes.innerHTML += "<span class='tag is-info'>" + gads_customer_lkup[customer_id] + "<button onclick='deleteGadsItem(\"" + customer_id + "\");' class='delete is-small'></button></span> ";
        campaign_ids.forEach((campaign_id) => {
          customer_boxes.innerHTML += "<span class='tag is-info is-light'>" + gads_campaign_lkup[campaign_id] + "(" + campaign_id + ")<button onclick='deleteGadsItem(\"" + customer_id + "\",\"" + campaign_id + "\");' class='delete is-small'></button></span> ";
        })
        customer_boxes.innerHTML += "<br><br>"
      }
    }

    function _getValueBetweenBrackets(string) {
      const openingIndex = string.indexOf('(');
      const closingIndex = string.indexOf(')');

      if (openingIndex < 0 || closingIndex < 0) {
        return '';
      }
      return string.substring(openingIndex + 1, closingIndex);
    }


    //Google Analytics code
    function addGa4Datasource() {
      tmp_ga4_data = JSON.parse(JSON.stringify(ga4_data));
      if (account_ids == null) {
        const api_url = "/_get_ga4_account_ids";
        addDDSpinner('ga4_account_div');
        addDDSpinner('ga4_property_div');
        fetch(api_url)
          .then(response => response.json())
          .then(data => {
            account_ids = data.result;
            _populateGa4Accounts();
            removeDDSpinner('ga4_account_div');
          });
      }
      _renderGa4MetricsBoxes();
      openPopup('google_analytics_datasource_tab');
    }

    function _populateGa4Accounts(acc_id = 0) {
      var first = true;
      if (account_ids != "error") {
        ga4_account_id_dd = document.getElementById('ga4_account_id_dd');
        account_ids.forEach((value) => {
          var newOption = new Option(value[1] + " (" + value[0] + ")", value[0]);
          ga4_account_id_dd.add(newOption);
          if (acc_id != 0 && first) {
            getGa4PropertyList(acc_id);
            first = false;
          }
          if (first) {
            getGa4PropertyList(value[0]);
            first = false;
          }
        })
        if (ga4_data.account) {
          document.getElementById('ga4_account_id_dd').value = ga4_data.account;
        }
      }
    }

    function _populateGa4Metrics() {
      ga4_metric_dd = document.getElementById('ga4_metric_dd');
      for (const [metric_id, metric_name] of Object.entries(ga4_metrics_lkup)) {
        var newOption = new Option(metric_name, metric_id);
        ga4_metric_dd.add(newOption);
      }
    }

    function getGa4PropertyList(account_id = 0) {
      if (account_id == 0) {
        account_id = document.getElementById('ga4_account_id_dd').value;
      }
      const api_url = "/_get_ga4_property_ids?account_id=" + account_id;
      ga4_property_id_dd = document.getElementById('ga4_property_id_dd');
      addDDSpinner('ga4_property_div');
      ga4_property_id_dd.innerHTML = "";
      fetch(api_url)
        .then(response => response.json())
        .then(data => {
          ga4_property_ids = data.result;
          if (ga4_property_ids != "error") {
            ga4_property_ids.forEach((value) => {
              var newOption = new Option(value[1] + " (" + value[0] + ")", value[0]);
              ga4_property_id_dd.add(newOption);
            })
          }
          if (ga4_data.property) {
            document.getElementById('ga4_property_id_dd').value = ga4_data.property;
          }
          removeDDSpinner('ga4_property_div');
        });
    }

    function addGa4Metric() {
      const ga4_metric = document.getElementById('ga4_metric_dd').value;
      if (!ga4_data.metrics.includes(ga4_metric)) {
        ga4_data.metrics.push(ga4_metric);
      }
      _renderGa4MetricsBoxes();
    }

    function _renderGa4MetricsBoxes() {
      ga4_metrics_boxes = document.getElementById('ga4_metrics_boxes');
      ga4_metrics_boxes.innerHTML = "";

      ga4_data.metrics.forEach((item) => {
        ga4_metrics_boxes.innerHTML += "<span class='tag is-info'>" + ga4_metrics_lkup[item] + "<button onClick='deleteGa4Metric(\"" + item + "\");' class='delete is-small'></button></span> ";
      });
    }

    function deleteGa4Metric(metric) {
      ga4_data.metrics.splice(ga4_data.metrics.indexOf(metric), 1);
      _renderGa4MetricsBoxes();
    }

    function saveGa4Datasource() {
      if (ga4_data.metrics.length > 0) {
        const ga4_account_dd = document.getElementById('ga4_account_id_dd');
        var final_ga4_account = ga4_account_dd.options[ga4_account_dd.selectedIndex].text;

        const ga4_property_dd = document.getElementById('ga4_property_id_dd');
        var final_ga4_property = ga4_property_dd.options[ga4_property_dd.selectedIndex].text;

        ga4_data.account = ga4_account_dd.value;
        ga4_data.property = ga4_property_dd.value;

        ga4_account_lkup[ga4_data.account] = final_ga4_account;
        ga4_property_lkup[ga4_data.property] = final_ga4_property;

        sessionStorage.setItem('ga4_data', JSON.stringify(gads_data));
        sessionStorage.setItem('ga4_account_lkup', JSON.stringify(ga4_account_lkup));
        sessionStorage.setItem('ga4_property_lkup', JSON.stringify(ga4_property_lkup));
        sessionStorage.setItem('account_ids', JSON.stringify(account_ids));
        _renderGa4DatasourceBox();
      }
      else {
        closePopup('final_ga4');
      }
      sessionStorage.setItem('ga4_data', JSON.stringify(ga4_data));
      closePopup('google_analytics_datasource_tab');
      cleanUp();
    }

    function _renderGa4DatasourceBox() {
      const final_ga4_details = document.getElementById('final_ga4_details');
      final_ga4_details.innerHTML = "Account and Property<br>";
      final_ga4_details.innerHTML += "<span class='tag is-info'>" + ga4_account_lkup[ga4_data.account] + "</span> <span class='tag is-info is-light'>" + ga4_property_lkup[ga4_data.property] + "</span><br><br>";
      final_ga4_details.innerHTML += "Variable(s)<br>";

      ga4_data.metrics.forEach((metric) => {
        final_ga4_details.innerHTML += "<span class='tag is-info'>" + ga4_metrics_lkup[metric] + "</span> ";
      })
      openPopup('final_ga4');
    }

    function cancelGa4Datasource() {
      ga4_data = JSON.parse(JSON.stringify(tmp_ga4_data));
      closePopup('google_analytics_datasource_tab');
      cleanUp();
    }

    function deleteGa4Datasource() {
      confirmBox("Delete Google Analytics Datasource",
        "Are you sure you want to delete the Google Analytics datasource?",
        function () {
          ga4_data = { 'account': [], 'property': [], 'metrics': [] };
          tmp_ga4_data = {};
          closePopup('final_ga4');
          sessionStorage.removeItem('ga4_data');
          cleanUp();
        },
        function () { });
    }

    function addBqDatasource() {
      tmp_bq_data = JSON.parse(JSON.stringify(bq_data));
      _renderBqMetricsBoxes();
      openPopup('bq_datasource_tab');
    }

    function saveBqDatasource() {
      bq_data.date_column = document.getElementById('bq_date_dd').value;
      //bq_data.values = document.getElementById('bq_value_dd').value;
      sessionStorage.setItem('bq_data', JSON.stringify(bq_data));
      sessionStorage.setItem('bq_metrics', JSON.stringify(bq_metrics));
      sessionStorage.setItem('bq_from_date', JSON.stringify(bq_from_date))
      sessionStorage.setItem('bq_to_date', JSON.stringify(bq_to_date))

      if (bq_data.metrics.length > 0) {
        _renderBqDatasourceBox();
      }
      else {
        closePopup('final_bq');
      }
      closePopup('bq_datasource_tab');
      cleanUp();
    }

    function deleteBqDatasource() {
      confirmBox("Delete BigQuery Datasource",
        "Are you sure you want to delete the BigQuery datasource?",
        function () {
          bq_data = { 'date_column': "", 'metrics': [] };
          tmp_bq_data = {};
          bq_metrics = [];
          bq_from_date = "";
          bq_to_date = "";
          sessionStorage.removeItem('bq_data');
          sessionStorage.removeItem('bq_metrics');
          sessionStorage.removeItem('bq_from_date');
          sessionStorage.removeItem('bq_to_date');
          sessionStorage.removeItem('bq_url');
          document.getElementById('bqProjectId').value = "";
          document.getElementById('bqDataset').value = "";
          document.getElementById('bqTable').value = "";
          document.getElementById('from_date_label').innerHTML = "";
          document.getElementById('to_date_label').innerHTML = "";
          closePopup('final_bq');
          cleanUp();
        },
        function () { });
    }

    function _renderBqDatasourceBox() {
      const final_bq_details = document.getElementById('final_bq_details');
      final_bq_details.innerHTML = `Datasource<br>
      <span class='tag is-danger'>BigQuery</span><br><br>
      <div class='columns'><div class='column is-one-third'>Date Column<br>
      <span class='tag is-info'>` + bq_data.date_column + `</span></div>
      </div>
      Variables (Metric)<br>`

      bq_data.metrics.forEach((val) => {
        final_bq_details.innerHTML += "<span class='tag is-info'>" + val + "</span> ";
      });
      openPopup('final_bq');
    }

    function cancelBqDatasource() {
      if (tmp_bq_data.date_column == "") {
        tmp_bq_data.date_column = bq_data.date_column;
      }

      if (bq_data.metrics.length == 0) {
        bq_data.date_column = "";
        bq_metrics = [];
        bq_from_date = "";
        bq_to_date = "";
      }
      bq_data = JSON.parse(JSON.stringify(tmp_bq_data));
      closePopup('bq_datasource_tab');
      cleanUp();
    }

    function uploadBq() {
      var bqProjectId = document.getElementById('bqProjectId').value;
      var bqDataset = document.getElementById('bqDataset').value;
      var bqTable = document.getElementById('bqTable').value;

      if (bqProjectId == "" || bqDataset == "" || bqTable == "") {
        openPopup('bq_upload_error');
        document.getElementById('bq_upload_error_msg').textContent = "Must fill in all the details (Project ID, Dataset and Table name)";
      }
      else {
        document.getElementById('bq_metrics_boxes').innerHTML = "";
        sessionStorage.setItem('bq_project_id', bqProjectId);
        sessionStorage.setItem('bq_dataset', bqDataset);
        sessionStorage.setItem('bq_table', bqTable);
        closePopup('bq_upload_error');
        addDDSpinner('getBqSheet');
        document.getElementById('bq_options').classList.add('div-disable');
        bq_data.metrics = [];
        const api_url = "/_get_bq_data?bq_project_id=" + bqProjectId + "&bq_dataset=" + bqDataset + "&bq_table=" + bqTable;
        fetch(api_url)
          .then(response => response.json())
          .then(data => {
            if (data.result[0] == "ok") {
              bq_data.date_column = data.result[1];
              bq_metrics = data.result[2];
              bq_from_date = data.result[3];
              bq_to_date = data.result[4];
              bq_items_loaded = false;

              setValidDates();
              _renderBqMetricsBoxes();
              closePopup('bq_upload_error');
              removeDDSpinner('getBqSheet');
            }
            else {
              document.getElementById('bq_upload_error_msg').textContent = data.result[1];
              openPopup('bq_upload_error');
              removeDDSpinner('getBqSheet');
              closePopup('bq_options');
            }
          });
      }
    }

    function _renderBqMetricsBoxes() {
      const bq_date_dd = document.getElementById('bq_date_dd');
      const bq_metric_dd = document.getElementById('bq_metric_dd');

      if (bq_metrics.length > 0 && !bq_items_loaded) {
        bq_date_dd.innerHTML = "";
        bq_metric_dd.innerHTML = "";
        bq_date_dd.add(new Option(bq_data.date_column, bq_data.date_column));

        bq_metrics.forEach((metric) => {
          bq_metric_dd.add(new Option(metric, metric));
          document.getElementById('bq_options').classList.remove('div-disable');
        });
        openPopup('bq_options');
        bq_items_loaded = true;
      }
      if (bq_metrics.length == 0) {
        bq_date_dd.innerHTML = "";
        bq_metric_dd.innerHTML = "";
        closePopup('bq_options');
      }
      bq_date_dd.disabled = true;

      bq_metrics_boxes = document.getElementById('bq_metrics_boxes');
      bq_metrics_boxes.innerHTML = "";

      bq_data.metrics.forEach((val) => {
        bq_metrics_boxes.innerHTML += "<span class='tag is-info'>" + val + "<button onClick='deleteBqMetric(\"" + val + "\");' class='delete is-small'></button></span> ";
      });

    }

    function addBqMetric() {
      const bq_metric = document.getElementById('bq_metric_dd').value;
      const bq_date = document.getElementById('bq_date_dd').value;
      if (!bq_data.metrics.includes(bq_metric) && bq_metric != bq_date) {
        bq_data.metrics.push(bq_metric);
        bq_data.date_column = bq_date;
      }
      _renderBqMetricsBoxes();
    }

    function clearAllBqMetric() {
      confirmBox("Clear All Metrics",
        "Are you sure you want to clear all the metrics?",
        function () {
          bq_data.metrics = [];
          _renderBqMetricsBoxes();
        },
        function () { });
    }

    function addAllBqMetric() {
      bq_data.metrics = [];
      const bq_date = document.getElementById('bq_date_dd').value;
      bq_data.date_column = bq_date;
      bq_metrics.forEach((metric) => {
        if (metric != bq_data.date_column) {
          bq_data.metrics.push(metric);
        }
      });
      _renderBqMetricsBoxes();
    }

    function deleteBqMetric(metric) {
      if (bq_data.metrics.includes(metric)) {
        bq_data.metrics.splice(bq_data.metrics.indexOf(metric), 1);
        _renderBqMetricsBoxes();
      }
    }


    //CSV Code
    function addCsvDatasource() {
      tmp_csv_data = JSON.parse(JSON.stringify(csv_data));
      _renderCsvMetricsBoxes();
      openPopup('csv_datasource_tab');
      gsheet_tab_visible = !document.getElementById('gsheet_tab_div').classList.contains('is-hidden');
    }

    function saveCsvDatasource() {
      csv_data.date_column = document.getElementById('csv_date_dd').value;
      sessionStorage.setItem('csv_data', JSON.stringify(csv_data));
      sessionStorage.setItem('csv_metrics', JSON.stringify(csv_metrics));
      sessionStorage.setItem('csv_from_date', JSON.stringify(csv_from_date))
      sessionStorage.setItem('csv_to_date', JSON.stringify(csv_to_date))
      sessionStorage.setItem('csv_format', JSON.stringify(csv_data.format))

      if (csv_data.metrics.length > 0) {
        _renderCsvDatasourceBox();
      }
      else {
        closePopup('final_csv');
      }
      closePopup('csv_datasource_tab');
      cleanUp();
    }

    function _renderCsvDatasourceBox() {
      const final_csv_details = document.getElementById('final_csv_details');
      final_csv_details.innerHTML = "Datasource<br>";
      if (csv_data.format == "csv") {
        final_csv_details.innerHTML += "<span class='tag is-link'>CSV</span><br><br>";
      }
      else {
        final_csv_details.innerHTML += "<span class='tag is-success'>gSheet</span><br><br>";
      }
      final_csv_details.innerHTML += "Date Column<br>";
      final_csv_details.innerHTML += "<span class='tag is-info'>" + csv_data.date_column + "</span><br><br>";
      final_csv_details.innerHTML += "Variable(s)<br>";

      csv_data.metrics.forEach((metric) => {
        final_csv_details.innerHTML += "<span class='tag is-info'>" + metric + "</span> ";
      })
      openPopup('final_csv');
    }

    function cancelCsvDatastore() {
      if (tmp_csv_data.date_column == "") {
        tmp_csv_data.date_column = csv_data.date_column;
      }

      if (csv_data.metrics.length == 0) {
        csv_data.date_column = "";
        csv_metrics = [];
        csv_from_date = "";
        csv_to_date = "";
      }
      csv_data = JSON.parse(JSON.stringify(tmp_csv_data));
      if (!gsheet_tab_visible) {
        document.getElementById('gsheet_tab_div').classList.add('is-hidden');
      }
      closePopup('csv_datasource_tab');
      cleanUp();
    }

    function uploadFile() {
      const form = document.querySelector('#file_upload_form');
      const fileInput = form.querySelector('input[type="file"]');
      const file = fileInput.files[0];
      sessionStorage.removeItem('gsheet_url');
      document.getElementById('gsUrl').value = "";
      if (file) {
        if ((file.size / 1024) > 250) {
          document.getElementById('file_too_big').classList.remove('is-hidden');
        }
        else {
          document.getElementById('file_too_big').classList.add('is-hidden');
          addDDSpinner('getCsv');
          document.getElementById('csv_options').classList.add('div-disable');
          const formData = new FormData();
          csv_data.metrics = [];
          formData.append('file', file);
          var fetchRequest = new Request('/upload_csv', {
            method: 'POST',
            body: formData
          });

          fetch(fetchRequest)
            .then(response => response.json())
            .then(data => {
              if (data.result[0] == "ok") {
                csv_data.date_column = data.result[1];
                csv_metrics = data.result[2];
                csv_from_date = data.result[3];
                csv_to_date = data.result[4];
                csv_items_loaded = false;
                csv_data.format = data.result[5];
                _renderCsvMetricsBoxes();
                closePopup('csv_upload_error');
                removeDDSpinner('getCsv');
              }
              else {
                document.getElementById('csv_upload_error_msg').innerHTML = data.result[1];
                openPopup('csv_upload_error');
                removeDDSpinner('getCsv');
              }
            });
        }
      }
    }

    function sheet_changed() {
      gs_sheet_changed = true;
    }

    function removeGid(url) {
      var gidMatches = url.match(/gid=\d+/g);
      if (gidMatches && gidMatches.length >= 2) {
        var firstGidIndex = url.indexOf(gidMatches[0]);
        var precedingCharacter = url.charAt(firstGidIndex - 1);
        if (precedingCharacter === "&") {
          firstGidIndex--;
        }
        return url.substring(0, firstGidIndex) + url.substring(firstGidIndex + gidMatches[0].length);
      }
      return url;
    }

    function uploadGs() {
      gsUrl = document.getElementById('gsUrl').value;
      gsUrl = removeGid(gsUrl);
      gsTab = "";
      if (!gs_sheet_changed) {
        if (document.getElementById('gsheet_tabs').options.length > 0) {
          gsTab = document.getElementById('gsheet_tabs').value;
          sessionStorage.setItem('gsheet_tab', gsTab);
        }
      }
      else {
        gs_sheet_changed = false;
      }
      if (gsUrl == "") {
        openPopup('gs_upload_error');
        document.getElementById('gs_upload_error_msg').textContent = "Must have a valid URL or Sheet ID";
      }
      else {
        sessionStorage.setItem('gsheet_url', gsUrl);
        closePopup('gs_upload_error');
        addDDSpinner('getGsSheet');
        document.getElementById('csv_options').classList.add('div-disable');
        csv_data.metrics = [];
        const api_url = "/_get_gs_data?gs_tab=" + gsTab + "&gid=" + (gsUrl.split('gid=')[1] ?? 0) + "&gs_url=" + gsUrl;
        fetch(api_url)
          .then(response => response.json())
          .then(data => {
            if (data.result[0] == "ok") {
              csv_data.date_column = data.result[1];
              csv_metrics = data.result[2];
              csv_from_date = data.result[3];
              csv_to_date = data.result[4];
              csv_items_loaded = false;
              csv_data.format = data.result[5];
              gsTab = data.result[8];
              sessionStorage.setItem('gsheet_tab', gsTab);
              sessionStorage.setItem('gsheet_tabs', JSON.stringify(data.result[7]));
              setValidDates();
              _rendergSheetTabs(data.result[7], gsTab);
              _renderCsvMetricsBoxes();
              closePopup('csv_upload_error');
              removeDDSpinner('getGsSheet');
            }
            else if (data.result[0] == "error") {
              gsTab = data.result[4];
              sessionStorage.setItem('gsheet_tab', gsTab);
              sessionStorage.setItem('gsheet_tabs', JSON.stringify(data.result[3]));
              _rendergSheetTabs(data.result[3], gsTab);
              document.getElementById('gs_upload_error_msg').textContent = data.result[1];
              openPopup('gs_upload_error');
              closePopup('csv_options');
              removeDDSpinner('getGsSheet');
            }
            else {
              document.getElementById('gs_upload_error_msg').textContent = data.result[1];
              openPopup('gs_upload_error');
              closePopup('csv_options');
              removeDDSpinner('getGsSheet');
            }
          });
      }
    }

    function _rendergSheetTabs(sheets, gsTab) {
      document.getElementById('gsheet_tab_div').classList.remove('is-hidden');
      gsheet_tabs = document.getElementById('gsheet_tabs');
      gsheet_tabs.innerHTML = "";
      sheets.forEach((tab) => {
        gsheet_tabs.add(new Option(tab, tab));
      });
      if (gsTab != "") {
        gsheet_tabs.value = gsTab;
      }
    }

    function setValidDates() {
      var f_date = document.getElementById('from_date');
      var t_date = document.getElementById('to_date');
      var event_date = document.getElementById('event_date');

      if ((bq_from_date > csv_to_date || csv_from_date > bq_to_date) && (bq_from_date != "" && bq_to_date != "" && csv_from_date != "" && csv_to_date != "")) {
        is_date_error = true;
        openPopup('csv_date_error');
        document.getElementById('csv_date_error_msg').innerHTML = "Date ranges in both sheets do not have any common dates and cannot be merged";
      }
      else {
        closePopup('csv_date_error');
        is_date_error = false;
        if (csv_from_date || bq_from_date) {
          if (!csv_from_date) {
            f_date.value = x_from_date = bq_from_date;
          }
          else if (!bq_from_date) {
            f_date.value = x_from_date = csv_from_date;
          }
          else if (csv_from_date > bq_from_date) {
            f_date.value = x_from_date = csv_from_date;
          }
          else {
            f_date.value = x_from_date = bq_from_date;
          }
        }
        if (csv_to_date || bq_to_date) {
          if (!csv_to_date) {
            t_date.value = x_to_date = bq_to_date;
          }
          else if (!bq_to_date) {
            t_date.value = x_to_date = csv_to_date;
          }
          else if (csv_to_date < bq_to_date) {
            t_date.value = x_to_date = csv_to_date;
          }
          else {
            t_date.value = x_to_date = bq_to_date;
          }
        }
      }
      if (csv_to_date && csv_from_date) {
        t_date.value = x_to_date = csv_to_date;
        f_date.value = x_from_date = csv_from_date;
      }
      if(t_date.value && f_date.value) {
        event_date.value = _getMiddleDate(t_date.value, f_date.value);
      }

      sessionStorage.setItem('x_from_date', x_from_date);
      sessionStorage.setItem('x_to_date', x_to_date);
      _showMinMaxDates();
    }

    function _getMiddleDate(startDateStr, endDateStr) {
      const startDate = new Date(startDateStr);
      const endDate = new Date(endDateStr);
      const startTimestamp = startDate.getTime();
      const endTimestamp = endDate.getTime();
      const middleTimestamp = (startTimestamp + endTimestamp) / 2;

      return (new Date(middleTimestamp)).toISOString().split("T")[0];
    }

    function _showMinMaxDates() {
      document.getElementById('from_date_label').innerHTML = "Min: " + x_from_date;
      document.getElementById('to_date_label').innerHTML = "Max: " + x_to_date;
    }

    function addCsvMetric() {
      const csv_metric = document.getElementById('csv_metric_dd').value;
      const csv_date = document.getElementById('csv_date_dd').value;
      if (!csv_data.metrics.includes(csv_metric) && csv_metric != csv_date) {
        csv_data.metrics.push(csv_metric);
        csv_data.date_column = csv_date;
      }
      _renderCsvMetricsBoxes();
    }

    function clearAllCsvMetric() {
      confirmBox("Clear All Metrics",
        "Are you sure you want to clear all the metrics?",
        function () {
          csv_data.metrics = [];
          _renderCsvMetricsBoxes();
        },
        function () { });
    }

    function addAllCsvMetric() {
      csv_data.metrics = [];
      const csv_date = document.getElementById('csv_date_dd').value;
      csv_data.date_column = csv_date;
      csv_metrics.forEach((metric) => {
        if (metric != csv_data.date_column) {
          csv_data.metrics.push(metric);
        }
      });
      _renderCsvMetricsBoxes();
    }

    function _renderCsvMetricsBoxes() {
      const csv_date_dd = document.getElementById('csv_date_dd');
      const csv_metric_dd = document.getElementById('csv_metric_dd');
      if (csv_metrics.length > 0 && !csv_items_loaded) {
        csv_date_dd.innerHTML = "";
        csv_metric_dd.innerHTML = "";
        csv_date_dd.add(new Option(csv_data.date_column, csv_data.date_column));
        csv_metrics.forEach((metric) => {
          csv_metric_dd.add(new Option(metric, metric));
          document.getElementById('csv_options').classList.remove('div-disable');
          openPopup('csv_options');
        });
        csv_items_loaded = true;
      }
      if (csv_metrics.length == 0) {
        csv_date_dd.innerHTML = "";
        csv_metric_dd.innerHTML = "";
        closePopup('csv_options');
      }
      csv_date_dd.disabled = true;


      ds = document.getElementById('ds');
      if (csv_data.format == "csv") {
        ds.textContent = "CSV";
        ds.classList.add('is-link');
        ds.classList.remove('is-success');
      }
      else {
        ds.textContent = "gsheet";
        ds.classList.add('is-success');
        ds.classList.remove('is-link');
      }

      csv_metrics_boxes = document.getElementById('csv_metrics_boxes');
      csv_metrics_boxes.innerHTML = "";

      csv_data.metrics.forEach((item) => {
        csv_metrics_boxes.innerHTML += "<span class='tag is-info'>" + item + "<button onClick='deleteCsvMetric(\"" + item + "\");' class='delete is-small'></button></span> ";
      })
    }

    function deleteCsvMetric(metric) {
      if (csv_data.metrics.includes(metric)) {
        csv_data.metrics.splice(csv_data.metrics.indexOf(metric), 1);
        _renderCsvMetricsBoxes();
      }
    }

    function deleteCsvDatasource() {
      confirmBox("Delete CSV/gSheet Datasource",
        "Are you sure you want to delete the CSV/gSheet datasource?",
        function () {
          csv_data = { 'date_column': "", 'metrics': [] };
          tmp_csv_data = {};
          csv_metrics = [];
          csv_from_date = "";
          csv_to_date = "";
          sessionStorage.removeItem('csv_data');
          sessionStorage.removeItem('csv_metrics');
          sessionStorage.removeItem('csv_from_date');
          sessionStorage.removeItem('csv_to_date');
          sessionStorage.removeItem('gsheet_url');
          sessionStorage.removeItem('gsheet_tab');
          sessionStorage.removeItem('gsheet_tabs');
          document.getElementById('gsUrl').value = "";
          document.getElementById('from_date_label').innerHTML = "";
          document.getElementById('to_date_label').innerHTML = "";
          document.getElementById('gsheet_tab_div').classList.add('is-hidden');
          closePopup('final_csv');
          cleanUp();
        },
        function () { });
    }

    function csv_option_click() {
      document.getElementById('csv_option_span').classList.remove('is-light');
      document.getElementById('csv_option_span').classList.add('is-link');
      document.getElementById('gsheet_option_span').classList.remove('is-success');
      document.getElementById('gsheet_option_span').classList.add('is-light');

      document.getElementById('csv_option').classList.remove('is-hidden');
      document.getElementById('gsheet_option').classList.add('is-hidden');
    }

    function gsheet_option_click() {
      document.getElementById('csv_option_span').classList.remove('is-link');
      document.getElementById('csv_option_span').classList.add('is-light');
      document.getElementById('gsheet_option_span').classList.remove('is-light');
      document.getElementById('gsheet_option_span').classList.add('is-success');

      document.getElementById('gsheet_option').classList.remove('is-hidden');
      document.getElementById('csv_option').classList.add('is-hidden');
    }


    //Run Analysis
    function generateData() {
      var data_to_send = {};

      var from_date = document.getElementById('from_date').value;
      var to_date = document.getElementById('to_date').value;
      var event_date = document.getElementById('event_date').value;
      var target_event = document.getElementById('target_event_dd').value;
      var errors = 0;

      sessionStorage.setItem('from_date', from_date);
      sessionStorage.setItem('to_date', to_date);
      sessionStorage.setItem('event_date', event_date);
      sessionStorage.setItem('target_event', target_event);

      data_to_send['from_date'] = from_date;
      data_to_send['to_date'] = to_date;
      data_to_send['event_date'] = event_date;
      data_to_send['target_event'] = target_event;
      data_to_send['pre_period_validation'] = document.getElementById('pre_period_check').checked;
      data_to_send['unaffectedness_validation'] = document.getElementById('unaffectedness_check').checked;
      data_to_send['unaffectedness_option'] = document.getElementById('unef_dd').value;
      data_to_send['matrix_validation'] = document.getElementById('matrix_check').checked;
      data_to_send['credibility'] = document.getElementById('credibility_slider').value;

      var data_sources = [];
      var mcc_id_ts = "";
      var ga4_id_ts = "";
      if (gads_data.metrics.length > 0) {
        data_to_send['gads'] = gads_data;
        mcc_id_ts = gads_data.mcc_id;
      }
      if (ga4_data.metrics.length > 0) {
        data_to_send['ga4'] = ga4_data;
        ga4_id_ts = ga4_data.account;
      }
      if (csv_data.metrics.length > 0) {
        data_to_send['csv'] = csv_data;
        data_to_send['csv_format'] = csv_data.format;
      }
      if (bq_data.metrics.length > 0) {
        data_to_send['bq'] = bq_data;
      }

      document.getElementById('data_to_send').value = JSON.stringify(data_to_send);
    }

    //Advanced Options
    function showAdvancedOptions() {
      openPopup('advanced_options');
      credibilitySliderChange();
    }

    function cancelAdvancedOptions() {
      closePopup('advanced_options');
    }

    function credibilitySliderChange() {
      var sliderVal = document.getElementById('credibility_slider_value');
      sliderVal.innerHTML = document.getElementById('credibility_slider').value + "%";
    }

    function saveAdvancedOptions() {
      sessionStorage.setItem('credibility', document.getElementById('credibility_slider').value);
      closePopup('advanced_options');
    }

    //General helpers
    function cleanUp() {
      target_event_dd = document.getElementById('target_event_dd');
      target_event_dd.innerHTML = "";
      if (gads_data.metrics.length == 0 && ga4_data.metrics.length == 0 && csv_data.metrics.length == 0 && bq_data.metrics.length == 0) {
        openPopup('no_datasources');
      }
      else {
        gads_data.metrics.forEach((metric) => {
          var newOption = new Option("GAds : " + gads_metrics_lkup[metric], "gads_" + metric);
          target_event_dd.add(newOption);
        });
        ga4_data.metrics.forEach((metric) => {
          var newOption = new Option("GA4 : " + ga4_metrics_lkup[metric], "ga4_" + metric);
          target_event_dd.add(newOption);
        });
        csv_data.metrics.forEach((metric) => {
          var newOption = new Option("CSV : " + metric, "csv_" + metric);
          target_event_dd.add(newOption);
        });
        bq_data.metrics.forEach((metric) => {
          var newOption = new Option("BQ : " + metric, "bq_" + metric);
          target_event_dd.add(newOption);
        });

        if (sessionStorage.getItem('target_event')) { document.getElementById('target_event_dd').value = sessionStorage.getItem('target_event'); }
        closePopup('no_datasources');
        setValidDates();
        target_event_dd_change();
      }
      validation();
    }

    function target_event_dd_change() {
      var target_event = document.getElementById('target_event_dd');
      var optionsArray = Array.from(target_event.options);
      var unef_dd = document.getElementById('unef_dd');
      unef_dd.innerHTML = "";

      for (let i = 0; i < target_event.options.length; i++) {
        const option = target_event.options[i];
        if (!option.selected) {
          const newOption = document.createElement("option");
          newOption.value = option.value;
          newOption.text = option.text;
          unef_dd.appendChild(newOption);
        }
      }
      validation();
    }

    function validation_change() {
      sessionStorage.setItem('val_pre_period_check', document.getElementById('pre_period_check').checked);
      sessionStorage.setItem('val_unef_check', document.getElementById('unaffectedness_check').checked);
      sessionStorage.setItem('val_unef_option', document.getElementById('unef_dd').value);
      sessionStorage.setItem('val_matrix_check', document.getElementById('matrix_check').checked);
    }
    function reset_timer() {
      if (sessionStorage.getItem('timer')) {
        if ((Date.now() - sessionStorage.getItem('timer')) / 1000 > 6300) { //6300 = 1h 45 mins
          resetAnalysis(true);
        }
      }
      else {
        sessionStorage.setItem('timer', Date.now());
      }
    }

    function validation() {
      reset_timer();

      var from_date = document.getElementById('from_date').value;
      var to_date = document.getElementById('to_date').value;
      var event_date = document.getElementById('event_date').value;
      var target_event = document.getElementById('target_event_dd');
      var errors = 0;

      if (from_date == "" || to_date == "" || event_date == "") {
        errors++;
      }
      if (((Date.parse(event_date) - Date.parse(from_date)) / 86400000) < 3 && ((Date.parse(event_date) - Date.parse(from_date)) / 86400000) >= 0) {
        openPopup('date_3_days');
        errors++;
      }
      else {
        closePopup('date_3_days');
      }
      if (((Date.parse(event_date) - Date.parse(from_date)) / 86400000) < 5 && ((Date.parse(event_date) - Date.parse(from_date)) / 86400000) >= 0) {
        document.getElementById('pre_period_check').checked = false;
        sessionStorage.setItem('val_pre_period_check', 'false');
        document.getElementById('pre_period_check').disabled = true;
      }
      else {
        document.getElementById('pre_period_check').disabled = false;
      }
      if (from_date > to_date && from_date != "" && to_date != "") {
        openPopup('date_error');
        errors++;
      }
      else {
        closePopup('date_error');
      }
      if (target_event.value == "") {
        errors++;
      }
      if ((x_from_date && x_to_date) && (from_date < x_from_date || to_date > x_to_date)) {
        alert(from_date + " | " + x_from_date + " | " + to_date + " | " + x_to_date);
        is_date_error = true;
        openPopup('csv_date_error');
        document.getElementById('csv_date_error_msg').innerHTML = "When using multiple sheet based datasources, selected dates must be in the data sets";
      }
      else {
        closePopup('csv_date_error');
      }

      if (is_date_error) {
        errors++;
      }

      if (event_date != "" && (event_date < from_date || event_date > to_date)) {
        openPopup('event_date_error');
        errors++;
      }
      else {
        closePopup('event_date_error');
      }

      if (gads_data.length == 0 && ga4_metrics.length == 0) {
        errors++;
      }

      if (target_event.length < 3) {
        openPopup('three_metrics_error');
        document.getElementById('unaffectedness_check').checked = false;
        document.getElementById('unaffectedness_check').disabled = true;
        document.getElementById('unef_dd').disabled = true;
      }
      else {
        closePopup('three_metrics_error');
        document.getElementById('unaffectedness_check').disabled = false;
        document.getElementById('unef_dd').disabled = false;
      }

      var run_analysis = document.getElementById('run_analysis');
      if (errors == 0) {
        run_analysis.disabled = false;
      }
      else {
        run_analysis.disabled = true;
      }
    }

    function confirmBox(title, message, yesCallback, noCallback) {
      document.getElementById('confirm_title').innerHTML = title;
      document.getElementById('confirm_message').innerHTML = message;
      document.getElementById('confirm_yes').onclick = function () {
        closePopup('confirm_box');
        yesCallback();
      };
      document.getElementById('confirm_no').onclick = function () {
        closePopup('confirm_box');
        noCallback();
      };
      openPopup('confirm_box');
    }

    document.forms.namedItem('run_analysis_form').addEventListener('submit', function () {
      reset_timer();
      openPopup('loading_modal');
      generateData();
    });

    window.onunload = function (event) {
      closePopup('loading_modal');
    }

    //_showMinMaxDates();

    var intervalId = window.setInterval(function () {
      reset_timer();
    }, 5000);
  </script>
  {% include "_footer.html" %}